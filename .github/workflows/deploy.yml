name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Deploy to VPS
        env:
          REMOTE_DIR: "~/signalcast-ingestor"
        run: |
          ssh -i ~/.ssh/id_ed25519 "$VPS_USER@$VPS_HOST" 'bash -s' <<'EOF'
          set -euo pipefail
          cd ~/signalcast-ingestor
          echo 'ðŸ”„ Pulling latest changes...'
          git pull --ff-only
          echo 'ðŸ“¦ Installing dependencies...'
          pnpm install --frozen-lockfile
          echo 'ðŸ—ï¸ Building application...'
          pnpm run build
          echo 'ðŸš€ Restarting PM2 ecosystem...'
          pm2 delete all || true
          pm2 start ecosystem.config.js --env production
          pm2 save
          echo 'ðŸ“Š PM2 status:'
          pm2 list
          echo 'âœ… Deployment complete!'
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519
